---
// Drop this component into your layout to enable astro-animations.
// All required styles and scripts are injected automatically.
---

<script>
  import { destroyAnimations, initAnimations } from './lib/observer.ts';

  document.addEventListener('astro:page-load', initAnimations);
  document.addEventListener('astro:before-swap', destroyAnimations);
  initAnimations();
</script>

<style is:global>
  /* ============================================================
   * _animate-base.css
   *
   * Base styles for scroll-triggered animations.
   * Progressive enhancement: elements are visible by default.
   * JS sets data-animate-ready on <body> after applying initial hidden states.
   * ============================================================ */

  /* Prevent horizontal scrollbar from off-screen translateX (slide/bounce/roll).
     clip avoids creating a scroll container (unlike hidden), so it won't
     interfere with sticky positioning or other layout features. */
  [data-animate-ready] {
    overflow-x: clip;
  }

  /* Custom property defaults */
  [data-animate] {
    --animate-duration: 700ms;
    --animate-delay: 0ms;
    --animate-easing: cubic-bezier(0, 0, 0.3, 1); /* ease-out-3 */
    --animate-start-opacity: 0;
    --animate-translate: 15vh;
    --animate-scale: 0.85;
    --animate-rotate: 90deg;
  }

  /* Hide elements until JS is ready — progressive enhancement guard.
     will-change is set/cleared by JS around animation lifecycle to
     avoid keeping compositor layers allocated permanently. */
  [data-animate-ready] [data-animate] {
    opacity: var(--animate-start-opacity);
  }

  /* Reverse elements start visible — they animate OUT on entry */
  [data-animate-ready] [data-animate][data-animate-reverse] {
    opacity: 1;
  }

  /* Play animation backwards and hold end state (hidden/transformed) */
  [data-animate-ready] [data-animate][data-animate-reverse].is-animating {
    animation-direction: reverse;
    animation-fill-mode: forwards;
  }

  /* 3D perspective for flip/fold is applied via perspective() in keyframes
     rather than the perspective property, which only affects children. */

  /* Fold transform-origin per direction */
  [data-animate="fold"][data-animate-direction="up"],
  [data-animate="fold"]:not([data-animate-direction]) {
    transform-origin: 50% 0%;
  }

  [data-animate="fold"][data-animate-direction="down"] {
    transform-origin: 50% 100%;
  }

  [data-animate="fold"][data-animate-direction="left"] {
    transform-origin: 0% 50%;
  }

  [data-animate="fold"][data-animate-direction="right"] {
    transform-origin: 100% 50%;
  }

  /* ---- Animated state ---- */
  /* The .is-animating class is toggled by the IntersectionObserver */
  [data-animate-ready] [data-animate].is-animating {
    opacity: 1;
    animation-duration: var(--animate-duration);
    animation-timing-function: var(--animate-easing);
    animation-delay: var(--animate-delay);
    animation-fill-mode: both;
  }

  /* Map animation type + direction to the correct @keyframes */
  [data-animate="fade"].is-animating {
    animation-name: fade-in;
  }

  /* Slide */
  [data-animate="slide"].is-animating,
  [data-animate="slide"][data-animate-direction="up"].is-animating {
    animation-name: slide-in-up;
  }
  [data-animate="slide"][data-animate-direction="down"].is-animating {
    animation-name: slide-in-down;
  }
  [data-animate="slide"][data-animate-direction="left"].is-animating {
    animation-name: slide-in-left;
  }
  [data-animate="slide"][data-animate-direction="right"].is-animating {
    animation-name: slide-in-right;
  }

  /* Bounce */
  [data-animate="bounce"].is-animating,
  [data-animate="bounce"][data-animate-direction="up"].is-animating {
    animation-name: bounce-in-up;
  }
  [data-animate="bounce"][data-animate-direction="down"].is-animating {
    animation-name: bounce-in-down;
  }
  [data-animate="bounce"][data-animate-direction="left"].is-animating {
    animation-name: bounce-in-left;
  }
  [data-animate="bounce"][data-animate-direction="right"].is-animating {
    animation-name: bounce-in-right;
  }

  /* Zoom */
  [data-animate="zoom"].is-animating {
    animation-name: zoom-in;
  }

  /* Flip */
  [data-animate="flip"].is-animating,
  [data-animate="flip"][data-animate-direction="up"].is-animating {
    animation-name: flip-in-up;
  }
  [data-animate="flip"][data-animate-direction="down"].is-animating {
    animation-name: flip-in-down;
  }
  [data-animate="flip"][data-animate-direction="left"].is-animating {
    animation-name: flip-in-left;
  }
  [data-animate="flip"][data-animate-direction="right"].is-animating {
    animation-name: flip-in-right;
  }

  /* Fold */
  [data-animate="fold"].is-animating,
  [data-animate="fold"][data-animate-direction="up"].is-animating {
    animation-name: fold-in-up;
  }
  [data-animate="fold"][data-animate-direction="down"].is-animating {
    animation-name: fold-in-down;
  }
  [data-animate="fold"][data-animate-direction="left"].is-animating {
    animation-name: fold-in-left;
  }
  [data-animate="fold"][data-animate-direction="right"].is-animating {
    animation-name: fold-in-right;
  }

  /* Roll */
  [data-animate="roll"].is-animating {
    animation-name: roll-in;
  }

  /* ---- Intensity presets ---- */
  [data-animate-intensity="subtle"] {
    --animate-translate: 5vh;
    --animate-scale: 0.95;
    --animate-rotate: 45deg;
  }

  /* "normal" is the default — values set on [data-animate] above */

  [data-animate-intensity="strong"] {
    --animate-translate: 30vh;
    --animate-scale: 0.7;
    --animate-rotate: 180deg;
  }

  /* ============================================================
   * _animate-keyframes.css
   *
   * CSS @keyframes for all 7 animation types.
   * Intensity is driven by CSS custom properties set on each element
   * by the IntersectionObserver script (--animate-translate, --animate-scale,
   * --animate-rotate). This keeps the keyframes reusable across intensity levels.
   * ============================================================ */

  /* -- Fade ------------------------------------------------------------------ */
  @keyframes fade-in {
    from {
      opacity: var(--animate-start-opacity, 0);
    }
    to {
      opacity: 1;
    }
  }

  /* -- Slide ----------------------------------------------------------------- */
  @keyframes slide-in-up {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: translateY(var(--animate-translate));
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slide-in-down {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: translateY(calc(var(--animate-translate) * -1));
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slide-in-left {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: translateX(var(--animate-translate));
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes slide-in-right {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: translateX(calc(var(--animate-translate) * -1));
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* -- Bounce ---------------------------------------------------------------- */
  @keyframes bounce-in-up {
    0% {
      opacity: var(--animate-start-opacity, 0);
      transform: translateY(var(--animate-translate));
    }
    60% {
      opacity: 1;
      transform: translateY(calc(var(--animate-translate) * -0.2));
    }
    80% {
      transform: translateY(calc(var(--animate-translate) * 0.05));
    }
    100% {
      transform: translateY(0);
    }
  }

  @keyframes bounce-in-down {
    0% {
      opacity: var(--animate-start-opacity, 0);
      transform: translateY(calc(var(--animate-translate) * -1));
    }
    60% {
      opacity: 1;
      transform: translateY(calc(var(--animate-translate) * 0.2));
    }
    80% {
      transform: translateY(calc(var(--animate-translate) * -0.05));
    }
    100% {
      transform: translateY(0);
    }
  }

  @keyframes bounce-in-left {
    0% {
      opacity: var(--animate-start-opacity, 0);
      transform: translateX(var(--animate-translate));
    }
    60% {
      opacity: 1;
      transform: translateX(calc(var(--animate-translate) * -0.2));
    }
    80% {
      transform: translateX(calc(var(--animate-translate) * 0.05));
    }
    100% {
      transform: translateX(0);
    }
  }

  @keyframes bounce-in-right {
    0% {
      opacity: var(--animate-start-opacity, 0);
      transform: translateX(calc(var(--animate-translate) * -1));
    }
    60% {
      opacity: 1;
      transform: translateX(calc(var(--animate-translate) * 0.2));
    }
    80% {
      transform: translateX(calc(var(--animate-translate) * -0.05));
    }
    100% {
      transform: translateX(0);
    }
  }

  /* -- Zoom ------------------------------------------------------------------ */
  @keyframes zoom-in {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: scale(var(--animate-scale));
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* -- Flip ------------------------------------------------------------------ */
  @keyframes flip-in-up {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: perspective(1000px) rotateX(var(--animate-rotate));
    }
    to {
      opacity: 1;
      transform: perspective(1000px) rotateX(0deg);
    }
  }

  @keyframes flip-in-down {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: perspective(1000px) rotateX(calc(var(--animate-rotate) * -1));
    }
    to {
      opacity: 1;
      transform: perspective(1000px) rotateX(0deg);
    }
  }

  @keyframes flip-in-left {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: perspective(1000px) rotateY(calc(var(--animate-rotate) * -1));
    }
    to {
      opacity: 1;
      transform: perspective(1000px) rotateY(0deg);
    }
  }

  @keyframes flip-in-right {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: perspective(1000px) rotateY(var(--animate-rotate));
    }
    to {
      opacity: 1;
      transform: perspective(1000px) rotateY(0deg);
    }
  }

  /* -- Fold ------------------------------------------------------------------ */
  @keyframes fold-in-up {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: perspective(1000px) rotateX(var(--animate-rotate));
    }
    to {
      opacity: 1;
      transform: perspective(1000px) rotateX(0deg);
    }
  }

  @keyframes fold-in-down {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: perspective(1000px) rotateX(var(--animate-rotate));
    }
    to {
      opacity: 1;
      transform: perspective(1000px) rotateX(0deg);
    }
  }

  @keyframes fold-in-left {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: perspective(1000px) rotateY(var(--animate-rotate));
    }
    to {
      opacity: 1;
      transform: perspective(1000px) rotateY(0deg);
    }
  }

  @keyframes fold-in-right {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: perspective(1000px) rotateY(var(--animate-rotate));
    }
    to {
      opacity: 1;
      transform: perspective(1000px) rotateY(0deg);
    }
  }

  /* -- Roll ------------------------------------------------------------------ */
  @keyframes roll-in {
    from {
      opacity: var(--animate-start-opacity, 0);
      transform: translateX(calc(var(--animate-translate) * -1))
        rotate(calc(var(--animate-rotate) * -1));
    }
    to {
      opacity: 1;
      transform: translateX(0) rotate(0deg);
    }
  }

  /* ============================================================
   * _scroll-timeline.css
   *
   * Pure CSS scroll-linked animations using animation-timeline: view().
   * Zero JS overhead — targets all elements with data-scroll-effect.
   * Uses --scroll-speed custom property for configurable intensity.
   * ============================================================ */

  /* -- Parallax -------------------------------------------------------------- */
  [data-scroll-effect="parallax"] {
    animation: scroll-parallax linear both;
    animation-timeline: view();
    animation-range: entry 0% exit 100%;
  }

  @keyframes scroll-parallax {
    from {
      transform: translateY(var(--scroll-speed, 50px));
    }
    to {
      transform: translateY(calc(var(--scroll-speed, 50px) * -1));
    }
  }

  /* -- Fade ------------------------------------------------------------------ */
  [data-scroll-effect="fade"] {
    animation: scroll-fade linear both;
    animation-timeline: view();
    animation-range: entry 0% cover 40%;
  }

  @keyframes scroll-fade {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* -- Scale ----------------------------------------------------------------- */
  [data-scroll-effect="scale"] {
    animation: scroll-scale linear both;
    animation-timeline: view();
    animation-range: entry 0% cover 50%;
  }

  @keyframes scroll-scale {
    from {
      transform: scale(0.8);
    }
    to {
      transform: scale(1);
    }
  }

  /* -- Rotate ---------------------------------------------------------------- */
  [data-scroll-effect="rotate"] {
    animation: scroll-rotate linear both;
    animation-timeline: view();
    animation-range: entry 0% exit 100%;
  }

  @keyframes scroll-rotate {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(var(--scroll-rotate, 180deg));
    }
  }

  /* -- Blur ------------------------------------------------------------------ */
  [data-scroll-effect="blur"] {
    animation: scroll-blur linear both;
    animation-timeline: view();
    animation-range: entry 0% cover 50%;
  }

  @keyframes scroll-blur {
    from {
      filter: blur(10px);
    }
    to {
      filter: blur(0px);
    }
  }

  /* -- Horizontal ------------------------------------------------------------ */
  [data-scroll-effect="horizontal"] {
    animation: scroll-horizontal linear both;
    animation-timeline: view();
    animation-range: entry 0% exit 100%;
  }

  @keyframes scroll-horizontal {
    from {
      transform: translateX(calc(var(--scroll-speed, 100px) * -1));
    }
    to {
      transform: translateX(var(--scroll-speed, 100px));
    }
  }

  /* ============================================================
   * _reduced-motion.css
   *
   * Reduced motion: force everything visible, kill all animation.
   * ============================================================ */

  @media (prefers-reduced-motion: reduce) {
    [data-animate] {
      opacity: 1 !important;
      transform: none !important;
      transition: none !important;
      animation: none !important;
    }

    [data-scroll-effect] {
      transform: none !important;
      filter: none !important;
      animation: none !important;
    }
  }

</style>
